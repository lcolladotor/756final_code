Calculate RMSPE, qvalues and compare with exons
===============================================

# Setup

## Libraries

```{r "setup"}
## Load libraries
## Available from http://cran.r-project.org/web/packages/getopt/index.html
# install.packages("getopt")
library("getopt")

## Available from http://cran.at.r-project.org/web/packages/knitrBootstrap/index.html
# install.packages("knitrBootstrap")
library("knitrBootstrap")

# --- Specify any other libraries you need
# --- Not needed (since you load them in template.R), but good for the report
# --- Anyhow, just copying and pasting from template.R is good
# install.packages("cvTools")
library("cvTools")

# install.packages("geepack")
library("geepack")

# install.packages("ggplot2")
library("ggplot2")

# source("http://bioconductor.org/biocLite.R")
# biocLite("qvalue")
library("qvalue")
```

## Directories

```{r "directories"}
## Chr
chr <- paste0("chr", opt$chrnum)
chrnum <- as.numeric(opt$chrnum)

## Create dir to save files
if(opt$verbose) message("Creating directories")
ddir <- file.path(opt$dirResult, opt$project, chr) # data directory (might change say if step2 uses the results from step2)
wdir <- file.path(opt$dirResult, opt$project, chr, opt$results) # working dir
dir.create(wdir, recursive=TRUE)

## Want to save some 'object'? Use:
# save(object, file=file.path(wdir, "object.Rdata"))
```




# RMSPE

```{r "loadData"}
load(file.path(ddir, "geeAR1", "geeAR1.Rdata"))
load(file.path(ddir, "geeInd", "geeInd.Rdata"))
load(file.path(ddir, "geeEx", "geeEx.Rdata"))
```

## Calculate the RMSPE

```{r "rmspe"}
rmspe.all <- vector("list", length(geeAR1))
names(rmspe.all) <- names(geeAR1)

rmspe.all <- lapply(names(rmspe.all), function(x) {
	ar <- unlist(rmspe(y=geeAR1[[x]]$y, yHat=geeAR1[[x]]$fitted.values, includeSE=TRUE))
	ind <- unlist(rmspe(y=geeInd[[x]]$y, yHat=geeInd[[x]]$fitted.values, includeSE=TRUE))
	ex <- unlist(rmspe(y=geeEx[[x]]$y, yHat=geeEx[[x]]$fitted.values, includeSE=TRUE))
	df <- data.frame(rbind(ar, ind, ex))
	df$method <- factor(c("AR1", "Ind", "Ex"))
	df$pairID <- rep(as.integer(x), 3)
	rownames(df) <- NULL
	return(df)
})
rmspe.all <- do.call(rbind, rmspe.all)
save(rmspe.all, file=file.path(wdir, "rmspe.all.Rdata"))
```

## Explore the results

```{r "rmspeEDA", device="CairoPNG"}
ggplot(rmspe.all, aes(x=method, y=rmspe)) + geom_violin()
ggplot(rmspe.all, aes(x=method, y=se)) + geom_violin()
plot(rmspe.all$rmspe[rmspe.all$method=="Ind"], rmspe.all$rmspe[rmspe.all$method=="Ex"])
abline(0, 1, col="red")
plot(rmspe.all$rmspe[rmspe.all$method=="Ind"], rmspe.all$rmspe[rmspe.all$method=="AR1"])
abline(0, 1, col="red")
plot(rmspe.all$se[rmspe.all$method=="Ind"], rmspe.all$se[rmspe.all$method=="Ex"])
abline(0, 1, col="red")
plot(rmspe.all$se[rmspe.all$method=="Ind"], rmspe.all$se[rmspe.all$method=="AR1"])
abline(0, 1, col="red")
ggplot(subset(rmspe.all, method!="Ex"), aes(x=rmspe, y=se, color=method)) + geom_point()
ggplot(subset(rmspe.all, method!="Ex"), aes(x=pairID, y=rmspe, color=method)) + geom_point()
ggplot(subset(rmspe.all, method!="Ex"), aes(x=pairID, y=se, color=method)) + geom_point()
tapply(rmspe.all$rmspe, rmspe.all$method, summary)
tapply(rmspe.all$se, rmspe.all$method, summary)
```


# Compare on exons

## Adjust q-values and perform tests

```{r "loadStats"}
load(file.path(ddir, "geeAR1", "geeAR1.stat.Rdata"))
load(file.path(ddir, "geeInd", "geeInd.stat.Rdata"))
load(file.path(ddir, "geeEx", "geeEx.stat.Rdata"))

pvals <- vector("list", length(geeAR1))
names(pvals) <- names(geeAR1)

pvals <- lapply(names(pvals), function(x) {
	ar <- geeAR1.stat[[x]]$pval[1]
	ind <- geeInd.stat[[x]]$pval[1]
	ex <- geeEx.stat[[x]]$pval[1]
	df <- data.frame(pval=c(ar, ind, ex))
	df$method <- factor(c("AR1", "Ind", "Ex"))
	df$pairID <- rep(as.integer(x), 3)
	return(df)
})
pvals <- do.call(rbind, pvals)
qvals <- rep(NA, nrow(pvals))
for(i in c("AR1", "Ind", "Ex")) {
	qvals[pvals$method == i] <- qvalue(pvals$pval[pvals$method == i])$qvalues
}
pvals$qval <- qvals
pvals$pvalSig <- pvals$pval < 0.05
pvals$qvalSig <- pvals$qval < 0.10
save(pvals, file=file.path(wdir, "pvals.Rdata"))
```

```{r "explorePvals", dev="CairoPNG"}
summary(pvals)
ggplot(pvals, aes(x=method, y=pval)) + geom_violin()
ggplot(pvals, aes(x=method, y=qval)) + geom_violin()
plot(pvals$qval[pvals$method=="Ind"], pvals$qval[pvals$method=="Ex"])
abline(0, 1, col="red")
plot(pvals$qval[pvals$method=="Ind"], pvals$qval[pvals$method=="AR1"])
abline(0, 1, col="red")
ggplot(subset(pvals, method!="Ex"), aes(x=pairID, y=qval, colour=method)) + geom_point()
```

# Region pairs and exons

```{r "pairsExons"}
load(file.path(ddir, "ov.Rdata"))

## Regions and exons: number of region pairs per exon
ov.df <- as.data.frame(ov.mat)
ex.tab <- table(ov.df$subjectHits[ ov.df$queryHits %in% unique(pvals$pairID)] )
ex.tab
## Exons with more than 1 region
idx.ex <- as.integer(names(ex.tab)[ ex.tab > 1])
ex.use <- ov.df[ ov.df$queryHits %in% unique(pvals$pairID) & ov.df$subjectHits %in% idx.ex, ]
save(ex.use, file=file.path(wdir, "ex.use.Rdata"))
head(ex.use)

## How many pairs were "linked"?
pvals.ex <- subset(pvals, pairID %in% ex.use$queryHits)
save(pvals.ex, file=file.path(wdir, "pvals.ex.Rdata"))

```

```{r "pairsExonsEDA", dev="CairoPNG"}
ggplot(pvals.ex, aes(x=method, y=pval)) + geom_violin()
ggplot(pvals.ex, aes(x=method, y=qval)) + geom_violin()

plot(pvals.ex$qval[pvals.ex$method=="Ind"], pvals.ex$qval[pvals.ex$method=="AR1"])
abline(0, 1, col="red")
ggplot(subset(pvals.ex, method!="Ex"), aes(x=pairID, y=qval, colour=method)) + geom_point()

## Judging by p-value
tapply(pvals.ex$pvalSig, pvals.ex$method, summary)
casesPval <- do.call(rbind, tapply(pvals.ex$pvalSig, pvals.ex$pairID, as.integer))
table(apply(casesPval, 1, paste, collapse="-"))

## Judging by q-value
tapply(pvals.ex$qvalSig, pvals.ex$method, summary)
casesQval <- do.call(rbind, tapply(pvals.ex$qvalSig, pvals.ex$pairID, as.integer))
table(apply(casesQval, 1, paste, collapse="-"))
```












# Reproducibility

Date the report was generated.

```{r "reproducibility1", echo=FALSE}
## Date the report was generated
Sys.time()
```

Wallclock time spent generating the report.

```{r "reproducibility2", echo=FALSE}
## Processing time in seconds
totalTime <- diff(c(startTime, Sys.time()))
round(totalTime, digits=3)
```

`R` session information.

```{r "reproducibility3", echo=FALSE}
## Session info
sessionInfo()
```
